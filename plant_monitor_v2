#!/usr/bin/env python3
"""
Plant Mood Monitor - Complete Version
监测植物土壤湿度并在OLED屏幕上显示表情
"""

import time
import board
import busio
from PIL import Image, ImageDraw, ImageFont

# ADS1115 ADC
import adafruit_ads1x15.ads1115 as ADS
from adafruit_ads1x15.analog_in import AnalogIn

# SSD1306 OLED
import adafruit_ssd1306


class PlantMoodMonitor:
    def __init__(self):
        # 初始化I2C
        self.i2c = busio.I2C(board.SCL, board.SDA)
        
        # 初始化ADC (ADS1115)
        try:
            self.ads = ADS.ADS1115(self.i2c, address=0x48)
            self.channel = AnalogIn(self.ads, ADS.P0)
            print("✓ ADS1115 ADC 初始化成功")
        except Exception as e:
            print(f"✗ ADS1115 初始化失败: {e}")
            self.ads = None
        
        # 初始化OLED
        try:
            self.oled = adafruit_ssd1306.SSD1306_I2C(128, 64, self.i2c, addr=0x3c)
            self.oled.fill(0)
            self.oled.show()
            print("✓ OLED 初始化成功")
        except Exception as e:
            print(f"✗ OLED 初始化失败: {e}")
            self.oled = None
        
        # 创建绘图对象
        self.image = Image.new("1", (128, 64))
        self.draw = ImageDraw.Draw(self.image)
        
        # 加载字体
        try:
            self.font = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 12)
            self.font_small = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 10)
        except:
            self.font = ImageFont.load_default()
            self.font_small = ImageFont.load_default()
        
        # 湿度阈值
        self.DRY_THRESHOLD = 40
        self.WET_THRESHOLD = 70
    
    def read_moisture(self):
        """读取土壤湿度"""
        if self.ads is None:
            return None, None
        
        try:
            voltage = self.channel.voltage
            # 转换为百分比 (根据传感器校准调整)
            # 假设: 干燥=2.5V, 湿润=1.0V
            moisture_percent = max(0, min(100, (2.5 - voltage) / 1.5 * 100))
            return voltage, moisture_percent
        except Exception as e:
            print(f"读取传感器错误: {e}")
            return None, None
    
    def get_mood(self, moisture):
        """根据湿度返回心情"""
        if moisture is None:
            return "UNKNOWN", "?"
        elif moisture < self.DRY_THRESHOLD:
            return "THIRSTY", ":("
        elif moisture > self.WET_THRESHOLD:
            return "HAPPY", ":)"
        else:
            return "OK", ":|"
    
    def draw_face(self, mood):
        """在OLED上绘制表情"""
        # 清屏
        self.draw.rectangle((0, 0, 128, 64), fill=0)
        
        # 绘制脸的轮廓 (圆形)
        self.draw.ellipse((34, 2, 94, 62), outline=1)
        
        if mood == "HAPPY":
            # 开心的眼睛
            self.draw.ellipse((48, 18, 56, 26), fill=1)
            self.draw.ellipse((72, 18, 80, 26), fill=1)
            # 微笑
            self.draw.arc((48, 30, 80, 50), 0, 180, fill=1)
        
        elif mood == "THIRSTY":
            # 悲伤的眼睛
            self.draw.ellipse((48, 20, 56, 28), fill=1)
            self.draw.ellipse((72, 20, 80, 28), fill=1)
            # 悲伤的嘴
            self.draw.arc((48, 38, 80, 55), 180, 360, fill=1)
            # 眼泪
            self.draw.polygon([(52, 30), (50, 38), (54, 38)], fill=1)
        
        elif mood == "OK":
            # 普通眼睛
            self.draw.ellipse((48, 18, 56, 26), fill=1)
            self.draw.ellipse((72, 18, 80, 26), fill=1)
            # 平直的嘴
            self.draw.line((50, 45, 78, 45), fill=1, width=2)
        
        else:
            # 未知状态 - 问号
            self.draw.text((58, 25), "?", font=self.font, fill=1)
    
    def update_display(self, voltage, moisture, mood):
        """更新OLED显示"""
        if self.oled is None:
            return
        
        # 绘制表情
        self.draw_face(mood)
        
        # 显示数据文字
        if voltage is not None:
            self.draw.text((0, 0), f"{voltage:.2f}V", font=self.font_small, fill=1)
        if moisture is not None:
            self.draw.text((0, 54), f"{moisture:.0f}%", font=self.font_small, fill=1)
        
        # 显示状态
        self.draw.text((96, 0), mood[:3], font=self.font_small, fill=1)
        
        # 更新到OLED
        self.oled.image(self.image)
        self.oled.show()
    
    def run(self):
        """主循环"""
        print("\n=== Plant Mood Monitor 启动 ===")
        print("按 Ctrl+C 退出\n")
        
        try:
            while True:
                # 读取湿度
                voltage, moisture = self.read_moisture()
                
                # 获取心情
                mood, emoji = self.get_mood(moisture)
                
                # 打印到终端
                if voltage is not None:
                    print(f"电压: {voltage:.3f}V | 湿度: {moisture:.1f}% | 状态: {mood} {emoji}")
                else:
                    print("传感器读取失败")
                
                # 更新显示
                self.update_display(voltage, moisture, mood)
                
                # 等待
                time.sleep(2)
        
        except KeyboardInterrupt:
            print("\n\n程序退出")
            # 清屏
            if self.oled:
                self.oled.fill(0)
                self.oled.show()


def main():
    monitor = PlantMoodMonitor()
    monitor.run()


if __name__ == "__main__":
    main()
