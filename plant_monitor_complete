#!/usr/bin/env python3
"""
Plant Monitoring System - Working Version
"""

import time
import json
import csv
from datetime import datetime
from pathlib import Path

class PlantStatus:
    """Plant status class"""
    
    HAPPY = "happy"
    THIRSTY = "thirsty"
    DARK = "dark"
    HOT = "hot"
    COLD = "cold"
    PERFECT = "perfect"
    
    EMOJI = {
        "happy": "ğŸ˜Š",
        "thirsty": "ğŸ˜¢",
        "dark": "ğŸ˜”",
        "hot": "ğŸ”¥",
        "cold": "â„ï¸",
        "perfect": "ğŸ˜",
    }
    
    MESSAGE = {
        "happy": "I'm feeling great!",
        "thirsty": "I am thirsty.",
        "dark": "Craving for sunlight!",
        "hot": "Too hot! Need water!",
        "cold": "Feeling cold!",
        "perfect": "Perfect conditions!",
    }
    
    def __init__(self):
        self.current_status = self.PERFECT
        self.emoji = self.EMOJI[self.current_status]
        self.message = self.MESSAGE[self.current_status]
        self.previous_status = None
    
    def update(self, temperature, light_lux, soil_moisture):
        """Update plant status based on sensor data"""
        
        self.previous_status = self.current_status
        
        # å®šä¹‰é˜ˆå€¼
        SOIL_MIN = 30
        SOIL_MAX = 80
        LIGHT_MIN = 100
        TEMP_MIN = 5
        TEMP_MAX = 35
        
        # æ£€æŸ¥æ‰€æœ‰æ•°æ®éƒ½æœ‰æ•ˆ
        if temperature is None or light_lux is None or soil_moisture is None:
            self.current_status = self.HAPPY
            self.emoji = self.EMOJI[self.current_status]
            self.message = self.MESSAGE[self.current_status]
            return
        
        # ä¼˜å…ˆçº§åˆ¤æ–­
        # 1. æ¸©åº¦è¿‡å†·
        if temperature < TEMP_MIN:
            self.current_status = self.COLD
        # 2. æ¸©åº¦è¿‡çƒ­
        elif temperature > TEMP_MAX:
            self.current_status = self.HOT
        # 3. å…‰ç…§ä¸è¶³
        elif light_lux < LIGHT_MIN:
            self.current_status = self.DARK
        # 4. åœŸå£¤å¤ªå¹²
        elif soil_moisture < SOIL_MIN:
            self.current_status = self.THIRSTY
        # 5. åœŸå£¤å¤ªæ¹¿
        elif soil_moisture > SOIL_MAX:
            self.current_status = self.THIRSTY
        # 6. å®Œç¾æ¡ä»¶
        elif (SOIL_MIN <= soil_moisture <= SOIL_MAX and 
              light_lux >= 500 and 
              15 <= temperature <= 30):
            self.current_status = self.PERFECT
        # 7. è‰¯å¥½çŠ¶æ€
        else:
            self.current_status = self.HAPPY
        
        self.emoji = self.EMOJI[self.current_status]
        self.message = self.MESSAGE[self.current_status]


class DataLogger:
    """Data logging system"""
    
    def __init__(self, log_dir="plant_data"):
        """Initialize data logging system"""
        self.log_dir = Path(log_dir)
        self.log_dir.mkdir(exist_ok=True)
        
        self.csv_file = self.log_dir / f"plant_log_{datetime.now().strftime('%Y%m%d')}.csv"
        self._init_csv()
    
    def _init_csv(self):
        """Initialize CSV file"""
        if not self.csv_file.exists():
            with open(self.csv_file, 'w', newline='') as f:
                writer = csv.writer(f)
                writer.writerow([
                    'Timestamp',
                    'Temperature(C)',
                    'Light(lux)',
                    'SoilMoisture(%)',
                    'SoilVoltage(V)',
                    'PlantStatus',
                    'Message'
                ])
    
    def log_data(self, data, plant_status):
        """Log data to CSV"""
        try:
            with open(self.csv_file, 'a', newline='') as f:
                writer = csv.writer(f)
                writer.writerow([
                    datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                    f"{data['temperature']:.2f}" if data['temperature'] is not None else "N/A",
                    f"{data['light']:.2f}" if data['light'] is not None else "N/A",
                    f"{data['soil_moisture']:.2f}" if data['soil_moisture'] is not None else "N/A",
                    f"{data['soil_voltage']:.3f}" if data['soil_voltage'] is not None else "N/A",
                    plant_status.current_status,
                    plant_status.message
                ])
        except Exception as e:
            print(f"âœ— Data logging failed: {e}")


class SensorStation:
    """Main sensor station class"""
    
    def __init__(self):
        print("Initializing sensors...\n")
        
        self.bmp280 = None
        self.bh1750 = None
        self.ads = None
        self.oled = None
        
        self._init_i2c()
        self._init_bmp280()
        self._init_bh1750()
        self._init_ads1115()
        self._init_oled()
        
        self.plant_status = PlantStatus()
        self.data_logger = DataLogger()
        
        print("\nâœ“ System initialized successfully!\n")
    
    def _init_i2c(self):
        """Initialize I2C bus"""
        try:
            import board
            import busio
            self.i2c = busio.I2C(board.SCL, board.SDA)
            print("âœ“ I2C bus initialized")
        except Exception as e:
            print(f"âœ— I2C initialization failed: {e}")
            self.i2c = None
    
    def _init_bmp280(self):
        """Initialize BMP280 - Try both addresses"""
        try:
            import adafruit_bmp280
            
            # å…ˆå°è¯• 0x76
            try:
                self.bmp280 = adafruit_bmp280.Adafruit_BMP280_I2C(
                    self.i2c, address=0x76
                )
                print("âœ“ BMP280 (Temperature) initialized at 0x76")
            except:
                # å†å°è¯• 0x77
                self.bmp280 = adafruit_bmp280.Adafruit_BMP280_I2C(
                    self.i2c, address=0x77
                )
                print("âœ“ BMP280 (Temperature) initialized at 0x77")
            
            self.bmp280.sea_level_pressure = 1013.25
        except Exception as e:
            print(f"âœ— BMP280 initialization failed: {e}")
    
    def _init_bh1750(self):
        """Initialize BH1750"""
        try:
            import adafruit_bh1750
            self.bh1750 = adafruit_bh1750.BH1750(
                self.i2c, address=0x23
            )
            print("âœ“ BH1750 (Light Sensor) initialized at 0x23")
        except Exception as e:
            print(f"âœ— BH1750 initialization failed: {e}")
    
    def _init_ads1115(self):
        """Initialize ADS1115 - Fixed version"""
        try:
            import adafruit_ads1x15.ads1115 as ADS
            from adafruit_ads1x15.analog_in import AnalogIn
            
            self.ads = ADS.ADS1115(self.i2c, address=0x48)
            
            # ä½¿ç”¨æ­£ç¡®çš„æ–¹å¼è·å–é€šé“
            self.soil_channel = AnalogIn(self.ads, ADS.P0)
            
            print("âœ“ ADS1115 (Soil Moisture) initialized at 0x48")
        except Exception as e:
            print(f"âœ— ADS1115 initialization failed: {e}")
            print(f"  Error: {type(e).__name__}: {str(e)}")
            
            # å°è¯•ä½¿ç”¨é€šé“æ•°å­—è€Œä¸æ˜¯ P0
            try:
                import adafruit_ads1x15.ads1115 as ADS
                from adafruit_ads1x15.analog_in import AnalogIn
                
                self.ads = ADS.ADS1115(self.i2c, address=0x48)
                self.soil_channel = AnalogIn(self.ads, 0)  # ä½¿ç”¨æ•°å­— 0 è€Œä¸æ˜¯ ADS.P0
                print("âœ“ ADS1115 (Soil Moisture) initialized at 0x48 (using channel 0)")
            except Exception as e2:
                print(f"âœ— ADS1115 alternative initialization also failed: {e2}")
    
    def _init_oled(self):
        """Initialize OLED Display"""
        try:
            import adafruit_ssd1306
            self.oled = adafruit_ssd1306.SSD1306_I2C(
                128, 64, self.i2c, addr=0x3c
            )
            print("âœ“ OLED Display initialized at 0x3c")
        except Exception as e:
            print(f"âœ— OLED initialization failed: {e}")
    
    def read_temperature(self):
        """Read temperature"""
        try:
            if self.bmp280:
                return self.bmp280.temperature
